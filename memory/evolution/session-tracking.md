# 会话状态追踪系统

## 问题背景
御主反馈：对话过程中经常"不理人"，不知道是卡住了还是在做什么，需要重启才能继续。

## 解决方案

### 1. Kanban 看板增加会话状态区域

```json
{
  "sessions": {
    "current": {          // 当前活跃会话
      "id": "main",
      "status": "active|processing|waiting|stuck",
      "lastActivity": "时间戳",
      "currentTask": "正在做什么",
      "startedAt": "开始时间"
    },
    "pending": [],        // 等待处理的任务
    "history": []         // 历史会话记录
  },
  "alerts": {
    "stuck": [],          // 卡住的任务
    "errors": [],         // 错误记录
    "warnings": []        // 警告
  }
}
```

### 2. 会话状态定义

| 状态 | 含义 | 御主可见 |
|------|------|----------|
| `active` | 空闲，等待输入 | ✅ |
| `processing` | 正在处理任务 | ✅ |
| `waiting` | 等待外部响应（API、网络等） | ✅ |
| `stuck` | 卡住了，需要关注 | ⚠️ 自动通知 |
| `error` | 遇到错误，尝试恢复中 | ⚠️ 自动通知 |

### 3. 自我恢复机制

**检测卡顿：**
- 如果 `processing` 状态超过 5 分钟 → 标记为 `stuck`
- 如果工具调用失败 3 次 → 标记为 `error`

**自动恢复：**
- `stuck`: 记录问题 → 尝试简化任务 → 继续执行
- `error`: 记录错误 → 尝试替代方案 → 如果无法解决，通知御主

**通知御主：**
- 卡顿超过 5 分钟 → 自动发送状态更新
- 错误无法自动恢复 → 发送详细错误信息

### 4. 实时更新规则

**每处理一个步骤：**
1. 更新 `kanban.json` 中的 `currentTask`
2. 更新 `lastActivity` 时间戳
3. 如果是长时间任务，定期更新状态

**遇到问题时：**
1. 记录到 `alerts` 数组
2. 更新会话状态为 `stuck` 或 `error`
3. 尝试自我恢复
4. 如果 3 次尝试失败，通知御主

### 5. Web 看板显示

在 http://101.132.81.50:8081/ 增加：

```
┌─────────────────────────────────────┐
│ 🟢 当前状态: active                 │
│ 📝 正在执行: 改进会话状态追踪系统    │
│ ⏰ 最后活动: 2 分钟前               │
├─────────────────────────────────────┤
│ ⚠️ 警告: 无                         │
│ ❌ 错误: 无                         │
└─────────────────────────────────────┘
```

---

## 实施检查清单

- [x] 更新 kanban.json 结构
- [ ] 更新 Web 看板页面（8081）
- [ ] 在 AGENTS.md 中添加状态更新规则
- [ ] 测试自我恢复机制

---

*创建时间: 2026-02-25*
